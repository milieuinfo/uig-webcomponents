<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <script src="/node_modules/@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="/node_modules/web-component-tester/browser.js"></script>

    <script type="module" src="../../../../../../../../../lib/components/map/index.js"></script>
    <script src="/node_modules/sinon/pkg/sinon.js"></script>
</head>

<body>
<test-fixture id="vl-map-modify-action-fixture">
    <template>
        <vl-map>
            <vl-map-features-layer>
                <vl-map-modify-action></vl-map-modify-action>
            </vl-map-features-layer>
        </vl-map>
    </template>
</test-fixture>
<test-fixture id="vl-map-modify-action-snapping-met-wfs-layers-fixture">
    <template>
        <vl-map>
            <vl-map-features-layer>
                <vl-map-modify-action
                        data-vl-snapping
                        data-vl-snapping-pixel-tolerance="1000">
                    <vl-map-wfs-layer
                            id="stromendwater"
                            data-vl-name="Stromend waterlichamen"
                            data-vl-url="https://geoserver.vmm.be/geoserver/vmm/wfs"
                            data-vl-layers="owl_l"
                            data-vl-max-resolution="4">
                        <vl-map-layer-style
                                data-vl-color="rgba(6, 163, 247, 0.4)"
                                data-vl-border-size="4"
                                data-vl-border-color="rgba(6, 163, 247, 1)"></vl-map-layer-style>
                    </vl-map-wfs-layer>
                    <vl-map-wfs-layer
                            id="stilstaandwater"
                            data-vl-name="Stilstaand waterlichamen"
                            data-vl-url="https://gisservices.inbo.be/arcgis/services/Watervlakken/MapServer/WFSServer?service=wfs"
                            data-vl-layers="Watervlakken"
                            data-vl-max-resolution="4">
                        <vl-map-layer-style
                                data-vl-color="rgba(6, 163, 247, 0.4)"
                                data-vl-border-size="4"
                                data-vl-border-color="rgba(6, 163, 247, 1)"></vl-map-layer-style>
                    </vl-map-wfs-layer>
                </vl-map-modify-action>
            </vl-map-features-layer>
        </vl-map>
    </template>
</test-fixture>

<script type="module">
    import {VlMapModifyAction} from "../../../../../../../../../lib";
    import {awaitUntil} from "../../../../../../../../utils/core";
    import {
        VlCompositeVectorLayer,
        VlCompositeVectorSource,
    } from "vl-mapactions/dist/vl-mapactions";

    suite("vl-map-modify-action", () => {
        const sandbox = sinon.createSandbox();

        setup((done) => {
            customElements.whenDefined("vl-map-modify-action").then(() => done());
        });

        teardown(() => {
            sandbox.restore();
        });

        test("een modify actie is een map actie", () => {
            assert.isTrue(VlMapModifyAction.isVlMapAction());
        });

        test("nadat de modify actie voltooid is, zal de onModify worden opgeroepen", async () => {
            const map = fixture("vl-map-modify-action-fixture");
            await map.ready;
            const modifyAction = map.querySelector("vl-map-modify-action");
            await awaitUntil(() => modifyAction.action != null);
            let featureModified = false;
            modifyAction.onModify((feature) => {
                assert.equal(feature, "gewijzigdeFeature");
                featureModified = true;
            });
            modifyAction.action.modifyInteraction.dispatchEvent({
                type: "modifyend",
                features: ["gewijzigdeFeature"],
            });

            await awaitUntil(() => featureModified === true);
        });

        test("snapping staat aan als er geen lagen onder de actie hangen", async () => {
            const map = fixture("vl-map-modify-action-fixture");
            const modifyAction = map.querySelector("vl-map-modify-action");
            await awaitUntil(() => modifyAction.action != null);
            const modifyActionOptions = modifyAction.action.options;

            expect(modifyActionOptions.snapping).to.equal(true);
        });

        test("snapping wordt goed geconfigureerd als er lagen zijn en pixel tolerantie", async () => {
            const mapMetSnapping = fixture("vl-map-modify-action-snapping-met-wfs-layers-fixture");
            const modifyMetSnappingOpWfsLagenAction = mapMetSnapping.querySelector("vl-map-modify-action");
            await awaitUntil(() => modifyMetSnappingOpWfsLagenAction.action != null);
            const modifyActionOptions = modifyMetSnappingOpWfsLagenAction.action.options;

            expect(modifyActionOptions.snapping.pixelTolerance).to.equal("1000");
            expect(modifyActionOptions.snapping.node).to.equal(false);
            expect(modifyActionOptions.snapping.vertex).to.equal(false);
            expect(modifyActionOptions.snapping.layer instanceof VlCompositeVectorLayer).to.equal(true);
            expect(modifyActionOptions.snapping.layer.getSource() instanceof VlCompositeVectorSource).to.equal(true);
            expect(modifyActionOptions.snapping.layer.getSource().sources[0])
                .to.equal(mapMetSnapping.querySelector("#stromendwater")._layer.getSource());
            expect(modifyActionOptions.snapping.layer.getSource().sources[1])
                .to.equal(mapMetSnapping.querySelector("#stilstaandwater")._layer.getSource());
            await awaitUntil(() => modifyActionOptions.snapping.layer.getStyle() == mapMetSnapping.querySelector("#stromendwater").style);
        });
    });
</script>
</body>
</html>
